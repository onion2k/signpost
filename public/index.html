<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>It's A Sign</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="css/materialize.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.0/easing/EasePack.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.0/TweenLite.min.js"></script>
        <style>
          canvas {
            padding: 0;
            margin: 0;
          }
          .collapsible-body {
            padding: 1rem;
          }
          .collapsible-body.active {
            display: block;
          }
        </style>
    </head>
    <body>

    <div class="navbar-fixed">
      <nav class="light-blue">
          <div class="nav-wrapper">
            <a href="#" class="brand-logo" style="margin-left: 10px;">It's A Sign</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
              <li><a href="sass.html">About</a></li>
              <li><a href="badges.html">Buy A Sign</a></li>
              <li><a href="sass.html">Custom Signs</a></li>
            </ul>
            <a href="#" data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
          </div>
      </nav>
    </div>

    <div class="row" style="margin-bottom: 0 !important; padding-bottom: 0;">
        <div class="col s4">

          <ul id="placelist" ref="placelist" style="margin-top: 15px;">

            <draggable :list="places" @change="onChange" class="dragArea">
              <placeedit v-for="place in places" v-bind:place="place" :key="place.place"></placeedit>
            </draggable>

            <li id="newplaceform" class="" v-bind:class="{ active: placeform }">
              <div class="collapsible-header" v-on:click="activateform" v-bind:class="{ active: placeform }"><i class="material-icons">location_on</i>Add a new place</div>
              <div class="collapsible-body" v-bind:class="{ active: placeform }" style="overflow: auto;">
                <form id="addplace">
                  <div class="form-group">
                    <label for="placename">Place</label>
                    <input type="text" class="form-control" v-model="place" placeholder="Eg Sunderland, UK">
                  </div>
                  <div class="form-group">
                    <label for="title">Title (Optional)</label>
                    <input type="text" class="form-control" v-model="title" placeholder="Eg Allison's House'">
                  </div>
                  <button type="button" id="addnewplace" v-on:click="addPlace" class="btn right waves-effect waves-light">Add Place</button>
                </form>
              </div>
            </li>
          </ul>

        </div>
        <div class="col s8 no-padding">
           <div style="min-height: 600px; padding: 0;" id="wrapper"></div>
        </div>
    </div>
    <footer class="page-footer">
        <div class="row">
          <div class="col l6 s12">
            <h5 class="white-text">Footer Content</h5>
            <p class="grey-text text-lighten-4">You can use rows and columns here to organize your footer content.</p>
          </div>
          <div class="col l4 offset-l2 s12">
            <h5 class="white-text">Links</h5>
            <ul>
              <li><a class="grey-text text-lighten-3" href="#!">Link 1</a></li>
              <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
              <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
              <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
            </ul>
          </div>
        </div>
      <div class="footer-copyright" style="padding-left: 10px;">
        Made by Onion2k
      </div>
    </footer>


        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="js/materialize.min.js"></script>
        <script src="js/vue.js"></script>
        <script src="js/Sortable.min.js"></script>
        <script src="js/vuedraggable.js"></script>
        <script src="dist/signpost.js"></script>
        <script src="/socket.io/socket.io.js"></script>

        <script>

          var socket = io.connect('http://localhost:8081');

          Vue.component('placeedit', {
            props: ['place'],
            data: function(){
              return { 'instancePlace': this.place.place, 'instanceTitle': this.place.title };
            },
            template: '<li class="place" v-bind:class="{ active: place.active }">\
              <div class="collapsible-header" v-on:click="activate(place)" v-bind:class="{ active: place.active }"><i class="material-icons">label</i>{{ instanceTitle || instancePlace }}</div>\
              <div class="collapsible-body" v-bind:class="{ active: place.active }" style="overflow: auto;">\
                <form id="editplace">\
                  <div class="form-group">\
                    <label for="placename">Place</label>\
                    <input type="text" placeholder="A place or an address" v-bind:value="instancePlace" @input="instancePlace = $event.target.value">\
                  </div>\
                  <div class="form-group">\
                    <label for="title">Title (Optional)</label>\
                    <input type="text" placeholder="Eg Allison\'s house" v-bind:value="instanceTitle" @input="instanceTitle = $event.target.value">\
                  </div>\
                  <button type="button" v-on:click="remove(place)" class="btn red waves-effect waves-light">Delete</button>\
                  <button type="button" v-on:click="edit(place)" class="btn right waves-effect waves-light">Update Place</button>\
                </form>\
              </div>\
            </li>',
            methods: {
              edit: function (place) {
                place.place = this.instancePlace;
                place.title = this.instanceTitle;
                app.editArm(place);
              },
              remove: function (place,index) {
                app.deleteArm(place);
              },
              activate: function(place){
                app.deactivate();
                place.active = !place.active;
              }
            }
          })

          var app = new Vue({
            el: '#placelist',
            data: {
              place: '',
              title: '',
              places: [{ place: 'France', index: 0, id: 'france', active: false }, { place: 'London', index: 1, id: 'london', active: false }, { place: 'Germany', index: 2, id: 'germany', active: false }, { place: 'Sunderland, UK', index: 3, id: 'sunderland', active: false }],
              placeform: true
            },
            created: function(){
              for (p in this.places) {
                var place = this.places[p];
                socket.emit('geocode', { place: place.place, title: place.title, index: p, id: place.id });
              }
            },
            methods: {
              addPlace: function (event) {
                socket.emit('geocode', { place: this.place, title: this.title });
              },
              addArm: function(title, place, bearing, distance, id){
                //TODO: Not keen on returning a value here ... not needed?
                this.places.push({ title: title, place: place, bearing: bearing, distance: distance, active: false, index: this.places.length, id: id });
                return this.places.length-1;
              },
              editArm: function(place){
                signpost.disarm(place.id).then(()=>{

                  this.places[place.index].title = place.title;
                  this.places[place.index].place = place.place;
                  socket.emit('geocode', { place: place.place, title: place.title, index: place.index, id: place.id, active: true });

                });
              },
              deleteArm: function(place){
                signpost.disarm(place.id);
                this.places.splice(place.index, 1);
                this.places.map(function(p){
                  if (p.index > place.index) {
                    p.index--;
                    signpost.move(p.id, +1);
                  }
                })
                this.activateform();
              },
              moveArm: function(bearing, distance, index) {
                this.places[index].bearing = bearing;
                this.places[index].distance = distance;
                return index;
              },
              onChange: function(e){
                if (e.moved) {
                  if (e.moved.newIndex > e.moved.oldIndex) {

                    signpost.move(this.places[e.moved.newIndex].id, -1 * (e.moved.newIndex - e.moved.oldIndex));

                    for (var x = e.moved.oldIndex; x < e.moved.newIndex; x++) {
                      signpost.move(this.places[x].id, +1);
                    }

                  } else {

                    signpost.move(this.places[e.moved.newIndex].id, -1 * (e.moved.newIndex - e.moved.oldIndex));

                    for (var x = e.moved.newIndex+1; x <= e.moved.oldIndex; x++) {
                      signpost.move(this.places[x].id, -1);
                    }

                  }

                }
              },
              activateform: function(place){
                this.deactivate();
                this.placeform = true;
              },
              deactivate: function() {
                for (place in this.places) {
                  this.places[place].active = false;
                }
                this.placeform = false;
              }
            }
          });

          socket.on('geocode', function (data) {
            var index, id;
            if (data[0].index === -1) {
              id = generateUUID();
              index = app.addArm(data[0].title, data[0].placename, data[0].bearing, data[0].distance, id);
            } else {
              id = data[0].id;
              index = app.moveArm(data[0].bearing, data[0].distance, data[0].index);
            }
            signpost.arm(data[0].title || data[0].placename, data[0].bearing, data[0].distance, index, id);
          });

          function generateUUID () {
              var d = new Date().getTime();
              if (typeof performance !== 'undefined' && typeof performance.now === 'function'){
                  d += performance.now();
              }
              return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                  var r = (d + Math.random() * 16) % 16 | 0;
                  d = Math.floor(d / 16);
                  return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
              });
          }

        </script>

    </body>
</html>
